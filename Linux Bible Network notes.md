## Demo

```bash
[root@localhost ~]# cat /etc/sysconfig/network-scripts/ifcfg-enp5s0f0
HWADDR=00:25:90:E7:E8:F4
TYPE=Ethernet
BOOTPROTO=static
DEFROUTE=yes
PEERDNS=yes
PEERROUTES=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_PEERDNS=yes
IPV6_PEERROUTES=yes
IPV6_FAILURE_FATAL=no
NAME=enp5s0f0
UUID=8f5cd0c3-dfda-47d1-8c1a-a0c167c4d660
ONBOOT=yes
IPADDR=172.18.1.140
NETMASK=255.255.255.0
GATEWAY=172.18.1.1
DNS1=114.114.114.114
```

```bash
[root@fedora ~]# nmcli -f NAME,DEVICE,FILENAME connection show
NAME        DEVICE      FILENAME
enp132s0f0  enp132s0f0  /etc/NetworkManager/system-connections/enp132s0f0.nmconnection
enp130s0f0  --          /etc/NetworkManager/system-connections/enp130s0f0.nmconnection
enp130s0f1  --          /etc/NetworkManager/system-connections/enp130s0f1.nmconnection
enp132s0f1  --          /etc/NetworkManager/system-connections/enp132s0f1.nmconnection
enp5s0f0    --          /etc/NetworkManager/system-connections/enp5s0f0.nmconnection
enp5s0f1    --          /etc/NetworkManager/system-connections/enp5s0f1.nmconnection

[root@fedora ~]# ip addr | grep -i 'state up'
6: enp132s0f0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000

[root@fedora ~]# nmcli connection show
NAME        UUID                                  TYPE      DEVICE
enp132s0f0  3a4db3d2-25fc-4155-a63f-53e489dd24ec  ethernet  enp132s0f0
enp130s0f0  98742ae3-f107-4f4e-88c3-a170ab7d80be  ethernet  --
enp130s0f1  fe1cdedc-f325-45f1-b4c2-18935e6fb435  ethernet  --
enp132s0f1  98f3463c-340b-4c3a-aeac-0827e00cc1d8  ethernet  --
enp5s0f0    5c654c40-8522-3ee2-8a22-c59b639f4987  ethernet  --
enp5s0f1    00d6b52e-1cf9-4275-80bb-71475298c3da  ethernet  --
```

```bash
nmcli connection modify enp132s0f0 ipv4.method manual ipv4.addresses 172.18.1.129/24 ipv4.gateway 172.18.1.1 ipv4.dns 223.5.5.5 connection.autoconnect yes
nmcli connection up enp132s0f0
```

```bash
[root@fedora ~]# nmcli device
DEVICE      TYPE      STATE        CONNECTION
enp132s0f0  ethernet  connected    enp132s0f0
enp130s0f0  ethernet  unavailable  --
enp130s0f1  ethernet  unavailable  --
enp132s0f1  ethernet  unavailable  --
enp5s0f0    ethernet  unavailable  --
enp5s0f1    ethernet  unavailable  --
lo          loopback  unmanaged    --
```

```bash
nmcli connection add con-name *Example-Connection* ifname *enp7s0* type ethernet

nmcli connection modify *Example-Connection* ipv4.addresses *192.0.2.1/24*

nmcli connection modify *Example-Connection* ipv6.addresses *2001:db8:1::1/64*

nmcli connection modify *Example-Connection* ipv4.method manual

nmcli connection modify *Example-Connection* ipv6.method manual

nmcli device status
```

---

```bash
# 查看连接
nmcli connection show

# 删除连接
nmcli connection delete ens33

# 查看设备
nmcli device

# 添加连接
nmcli connection add con-name ens33 ifname ens33 type ethernet

# 查看连接
[root@localhost ~]# nmcli -f NAME,DEVICE,FILENAME connection show
NAME   DEVICE  FILENAME
ens33  ens33   /etc/sysconfig/network-scripts/ifcfg-ens33
[root@localhost ~]# cat /etc/sysconfig/network-scripts/ifcfg-ens33
TYPE=Ethernet
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=dhcp
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=ens33
UUID=b2375b29-b000-4dc6-898d-f1d27378660a
DEVICE=ens33
ONBOOT=yes

# 添加 DNS
[root@localhost ~]# nmcli connection modify ens33 ipv4.dns "223.5.5.5 223.6.6.6"
[root@localhost ~]# grep -i dns /etc/sysconfig/network-scripts/ifcfg-ens33
DNS1=223.5.5.5
DNS2=223.6.6.6

# 激活连接以生效配置
nmcli connection up ens33
```

---

## Manually managing network interfaces

* Debian 系列: `/etc/network/interfaces`

```bash
# 修改完配置文件后，重启服务
sudo systemctl restart networking
```

* Redhat 系列: `/etc/sysconfig/network-scripts/ifcfg-xxx`

```bash
# 修改完配置文件后，重启服务
sudo systemctl restart network
```

---

## Network interface files

* aliases (multiple IP addresses for the same interface)

* bonded interfaces (Ethernet channel bonding, multiple NICs listening on the same address)

* custom routes

---

Network interface files

`/etc/sysconfig/network-scripts/ifcfg-enp4s1` static demo:

```ini
DEVICE=enp4s1
HWADDR=00:1B:21:0A:E8:5E
TYPE=Ethernet
BOOTPROTO=none
ONBOOT=yes
USERCTL=no
IPADDR=192.168.0.140
NETMASK=255.255.255.0
GATEWAY=192.168.0.1
```

---

System-wide settings associated with your local networking can be included in your `/etc/sysconfig/network` file. 

```bash
GATEWAY=192.168.0.1
```

---

`/etc/hosts`

```
127.0.0.1 localhost localhost.localdomain
::1       localhost localhost.localdomain
192.168.0.201 node1.example.com node1 joe
192.168.0.202 node2.example.com node2 sally
```

---

`/etc/resolv.conf`

```
# Generated by NetworkManager
nameserver 192.168.0.2
nameserver 192.168.0.3
```

---

## Ignore automatically configured nameservers and search domains from DHCP

```bash
[root@localhost ~]# cat /etc/resolv.conf
# Generated by NetworkManager
search localdomain
nameserver 192.168.91.2
nameserver 223.5.5.5
nameserver 223.6.6.6
[root@localhost ~]# grep -i dns /etc/sysconfig/network-scripts/ifcfg-ens33
DNS1=223.5.5.5
DNS2=223.6.6.6
[root@localhost ~]# nmcli connection modify ens33 ipv4.ignore-auto-dns yes
[root@localhost ~]# nmcli connection up ens33
Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/5)
[root@localhost ~]# cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 223.5.5.5
nameserver 223.6.6.6
[root@localhost ~]# grep -i dns /etc/sysconfig/network-scripts/ifcfg-ens33
DNS1=223.5.5.5
DNS2=223.6.6.6
PEERDNS=no
```

---

`/etc/nsswitch.conf`

Unlike in earlier releases, the `/etc/nsswitch.conf` file is managed by the `authselect` command and should not be modified manually. To make changes, edit the `/etc/authselect/user-nsswitch.conf` file and run `authselect apply-changes`.

---

* `host <DOMAIN>`

* `dig <DOMAIN>`

* `getent hosts node1`

```bash
[eric@fedora-s-1vcpu-1gb-lon1-01 ~]$ host redhat.com
redhat.com has address 52.200.142.250
redhat.com has address 34.235.198.240
redhat.com mail is handled by 10 us-smtp-inbound-1.mimecast.com.
redhat.com mail is handled by 10 us-smtp-inbound-2.mimecast.com.
[eric@fedora-s-1vcpu-1gb-lon1-01 ~]$ dig redhat.com

; <<>> DiG 9.16.30-RH <<>> redhat.com
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 44693
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:
;redhat.com.                    IN      A

;; ANSWER SECTION:
redhat.com.             584     IN      A       34.235.198.240
redhat.com.             584     IN      A       52.200.142.250

;; Query time: 0 msec
;; SERVER: 127.0.0.53#53(127.0.0.53)
;; WHEN: Tue Jul 26 10:42:45 CST 2022
;; MSG SIZE  rcvd: 71

[eric@fedora-s-1vcpu-1gb-lon1-01 ~]$ getent hosts localhost
::1             localhost.localdomain localhost
```

---

## alias

### 配置文件管理

`/etc/sysconfig/network-scripts/eth1:0`

```ini
DEVICE=eth0:0
ONPARENT=yes
IPADDR=192.168.0.141
NETMASK=255.255.255.0
```

在新版本允许直接在主配置文件 `/etc/sysconfig/network-scripts/eth1` 创建 alias，如

```ini
IPADDR=192.168.0.187
PREFIX=24
IPADDR1=192.168.99.1
PREFIX1=24
```

### nmcli 管理

```bash
[eric@fedora-s-1vcpu-1gb-lon1-01 ~]$ sudo nmcli connection modify 'cloud-init eth1' +ipv4.addresses 192.168.1.1
[eric@fedora-s-1vcpu-1gb-lon1-01 ~]$ sudo systemctl restart NetworkManager
[eric@fedora-s-1vcpu-1gb-lon1-01 ~]$ ip addr show eth1
3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq state UP group default qlen 1000
    link/ether ee:78:d9:fc:99:d4 brd ff:ff:ff:ff:ff:ff
    altname enp0s4
    altname ens4
    inet 10.106.0.2/20 brd 10.106.15.255 scope global noprefixroute eth1
       valid_lft forever preferred_lft forever
    inet 192.168.1.1/32 scope global noprefixroute eth1
       valid_lft forever preferred_lft forever
    inet6 fe80::3e4b:448e:84ad:35a3/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
```

## Configuring network bonding

### Understanding network bonding

Network bonding is a method to combine or aggregate network interfaces to provide a logical interface with higher throughput or redundancy.

The `active-backup`, `balance-tlb`, and `balance-alb` modes do not require any specific configuration of the network switch. However, other bonding modes require configuring the switch to aggregate the links.

### Upstream Switch Configuration Depending on the Bonding Modes

| Bonding mode          | Configuration on the switch                                |
| --------------------- | ---------------------------------------------------------- |
| `0` - `balance-rr`    | Requires static Etherchannel enabled (not LACP-negotiated) |
| `1` - `active-backup` | Requires autonomous ports                                  |
| `2` - `balance-xor`   | Requires static Etherchannel enabled (not LACP-negotiated) |
| `3` - `broadcast`     | Requires static Etherchannel enabled (not LACP-negotiated) |
| `4` - `802.3ad`       | Requires LACP-negotiated Etherchannel enabled              |
| `5` - `balance-tlb`   | Requires autonomous ports                                  |
| `6` - `balance-alb`   | Requires autonomous ports                                  |

* source: [Configuring network bonding](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/9/html/configuring_and_managing_networking/configuring-network-bonding_configuring-and-managing-networking#doc-wrapper)

> * **mode 0 (balance-rr)**
> 
> Round-robin policy. Transmits packets in sequential order from the first available slave through the last. This mode provides load balancing and fault tolerance.
> 
> * **mode 1 (active-backup)**
> 
> Active-backup policy. Establishes that only one slave in the bond is active. A different slave becomes active if, and only if, the active slave fails. The bond's MAC address is externally visible on only one port (network adapter) to avoid confusing the switch. This mode provides fault tolerance. The primary option affects the behavior of this mode.
> 
> * **mode 2 (balance-xor)**
> 
> Transmits based on the selected transmit hash policy, which can be altered via the **xmit_hash_policy** option. This mode provides load balancing and fault tolerance.
> 
> * **mode 3 (broadcase)**
> 
> Transmits everything on all slave interfaces. This mode provides fault tolerance.
> 
> * **mode 4 (802.3ad)**
> 
> IEEE 802.3ad Dynamic link aggregation policy. Creates aggregation groups that share the same speed and duplex settings. Utilizes all slaves in the active aggregator according to the 802.3ad specification.
> 
> * **mode 5 (balance-tlb)**
> 
> Adaptive transmit load balancing. Establishes channel bonding that does not require any special switch support. The outgoing traffic is distributed according to the current load (computed relative to the speed) on each slave. Incoming traffic is received by the current slave. If the receiving slave fails, another slave takes over the MAC address of the failed receiving slave.
> 
> * **mode 6 (balance-alb)**
> 
> Adaptive load balancing. Includes balance-transmit load balancing plus receive-load balancing for IPv4 traffic, and does not require any special switch support. The receive-load balancing is achieved by ARP negotiation. The bonding driver intercepts the ARP replies sent by the local system on their way out and overwrites the source hardware address with the unique hardware address of one of the slaves in the bond. Thus, different peers use different hardware addresses for the server.
> 
> * source: [Bonding modes](https://www.ibm.com/docs/en/linux-on-systems?topic=recommendations-bonding-modes)

```bash
[root@localhost ~]# nmcli connection add type bond con-name bond0 ifname bond0 bond.options "mode=active-backup,miimon=1000"
Connection 'bond0' (4d3eef6d-dc30-4bb4-b37b-9082949edcca) successfully added.
[root@localhost ~]# nmcli device status
DEVICE  TYPE      STATE                                  CONNECTION
ens33   ethernet  connected                              ens33
bond0   bond      connecting (getting IP configuration)  bond0
ens36   ethernet  disconnected                           --
ens37   ethernet  disconnected                           --
lo      loopback  unmanaged
[root@localhost ~]# nmcli connection add type ethernet slave-type bond con-name bond0-port1 ifname ens36 master bond0
Connection 'bond0-port1' (41da1eb7-f154-4258-a916-1fd27c6018c2) successfully added.
[root@localhost ~]# nmcli connection add type ethernet slave-type bond con-name bond0-port2 ifname ens37 master bond0
Connection 'bond0-port2' (64cf315e-0582-4f04-ab40-dd72eaa1268e) successfully added.

[root@localhost ~]# nmcli connection modify ens33 master bond0

[root@localhost ~]# nmcli connection up bond0
Connection successfully activated (master waiting for slaves) (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/11)
[root@localhost ~]# cat /etc/sysconfig/network-scripts/ifcfg-bond0
BONDING_OPTS="miimon=1000 mode=active-backup"
TYPE=Bond
BONDING_MASTER=yes
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=dhcp
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=bond0
UUID=fa07fa02-6022-4627-9bd9-8f0b6a659ae0
DEVICE=bond0
ONBOOT=yes
[root@localhost ~]# cat /etc/sysconfig/network-scripts/ifcfg-bond0-port1
TYPE=Ethernet
NAME=bond0-port1
UUID=41da1eb7-f154-4258-a916-1fd27c6018c2
DEVICE=ens36
ONBOOT=yes
MASTER=bond0
SLAVE=yes
[root@localhost ~]# cat /etc/sysconfig/network-scripts/ifcfg-bond0-port2
TYPE=Ethernet
NAME=bond0-port2
UUID=64cf315e-0582-4f04-ab40-dd72eaa1268e
DEVICE=ens37
ONBOOT=yes
MASTER=bond0
SLAVE=yes
```

When you activate any port of the connection, NetworkManager also activates the bond, but not the other ports of it. You can configure that Red Hat Enterprise Linux enables all ports automatically when when the bond is enabled:

1. Enable the `connection.autoconnect-slaves` parameter of the bond’s connection:

```bash
# nmcli connection modify bond0 connection.autoconnect-slaves 1
```

Reactivate the bridge:

```bash
# nmcli connection up bond0
```
